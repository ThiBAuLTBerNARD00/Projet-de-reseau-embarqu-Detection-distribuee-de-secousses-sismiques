/*
 * tasks.h
 *
 *  Created on: Dec 26, 2025
 *      Author: thiba
 */

#ifndef INC_TASKS_H_
#define INC_TASKS_H_
#include "stm32f7xx_hal.h"
#include "cmsis_os.h"
#include <stdbool.h>
#include "lwip/netif.h"
#include "lwip/udp.h"
#include "lwip/dns.h"
#include "lwip/timeouts.h"
#include "lwip/sockets.h"
#include "lwip/api.h"
#include <stdarg.h>
extern osSemaphoreId SemaphoreMasterHandle;
extern osSemaphoreId adcSemaphoreHandle;
extern osMutexId uartMutexHandle;
extern osMessageQId messageQueueHandle;

extern UART_HandleTypeDef huart3;
extern ADC_HandleTypeDef hadc1;
extern SPI_HandleTypeDef hspi2;
extern TIM_HandleTypeDef htim2;
extern I2C_HandleTypeDef hi2c1;


#define MAX_MSG_LEN 128
#define NTP_SERVER "pool.ntp.org"
#define NTP_PORT 123
#define NTP_TIMESTAMP_DELTA 2208988800UL // Différence entre 1900 et 1970
#define AXIS_COUNT     3
#define SAMPLES        64
#define ADC_BUF_LEN    (AXIS_COUNT * SAMPLES)
#define SAMPLE_RATE     100     // 100 Hz
#define RMS_WINDOW      SAMPLE_RATE   // 1 seconde = 100 échantillons
#define MA_WINDOW       10            // moyenne glissante 100 ms
#define TCP_SERVER_PORT     1234
#define UDP_LISTEN_PORT     1234   /* port sur lequel on écoute les broadcasts */
#define UDP_BROADCAST_PORT  1234
#define MAX_IPS 10
extern char broadcast_ip_list[MAX_IPS][16];
extern uint8_t ip_count;
extern uint8_t ip_index;

extern uint16_t adc_buf[ADC_BUF_LEN];

extern float rmsBufX[RMS_WINDOW];
extern float rmsBufY[RMS_WINDOW];
extern float rmsBufZ[RMS_WINDOW];
extern uint16_t rmsIndex;
extern uint8_t rmsFilled;

extern float maX, maY, maZ;
extern float rmsX, rmsY, rmsZ;

extern float baselineX, baselineY, baselineZ;
extern float threshold;

extern char last_broadcast_ip[16];
extern char ts[32];

#define EEPROM_WREN	0x06
#define EEPROM_WRITE	0x02
#define EEPROM_READ	0x03
#define FRAM_BASE_ADDR     0x0000
#define FRAM_NODE_SIZE    16    // 3 floats (12 octets) + marge
#define MAX_NODES         12
typedef struct {
    float rms_x;
    float rms_y;
    float rms_z;
} FramRMS_t;
#define BQ32000_ADDRESS 0x68 << 1
typedef struct {
    uint8_t id;
    char text[512];
} Message_t;

typedef struct{
	uint8_t year;
	uint8_t month;
	uint8_t date;
	uint8_t day;
	uint8_t hours;
	uint8_t minutes;
	uint8_t seconds;
}RTC_extern;

void StartClientTask(void const * argument);
void StartServerTask(void const * argument);
void StartADCTask(void const * argument);
void StartHeartBeatTask(void const * argument);
void StartBroadCast(void const * argument);
void StartMasterTask(void const * argument);
void StartServerBroadcastTask(void const * argument);
void StartRTCTask(void const * argument);
void LogMessageTask(void const * argument);


#endif /* INC_TASKS_H_ */
